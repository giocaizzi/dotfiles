# ============================================================================
# POSIX SHELL CONFIGURATION (Core)
# ============================================================================
# This file contains POSIX-compliant configuration shared between bash and zsh.
# It is sourced by both .bashrc and .zshrc to avoid duplication.
#
# IMPORTANT: Keep this file POSIX-compliant - no bash/zsh-specific syntax!
# Test with: shellcheck -s sh ~/.profile
# ============================================================================

# ----------------------------------------------------------------------------
# 1. ENVIRONMENT VARIABLES
# ----------------------------------------------------------------------------

# Default editor
export EDITOR='vim'
export VISUAL='vim'

# ----------------------------------------------------------------------------
# 2. PATH CONFIGURATION
# ----------------------------------------------------------------------------

# Homebrew (macOS - Intel and Apple Silicon)
if [ -f /opt/homebrew/bin/brew ]; then
	eval "$(/opt/homebrew/bin/brew shellenv)"
elif [ -f /usr/local/bin/brew ]; then
	eval "$(/usr/local/bin/brew shellenv)"
fi

# Homebrew PostgreSQL (keg-only formulas need explicit PATH)
if [ -n "$HOMEBREW_PREFIX" ]; then
	for pg_formula in postgresql@17 postgresql@16 postgresql@15 postgresql; do
		if [ -d "$HOMEBREW_PREFIX/opt/$pg_formula/bin" ]; then
			export PATH="$HOMEBREW_PREFIX/opt/$pg_formula/bin:$PATH"
			break
		fi
	done
fi

# pipx
export PATH="$HOME/.local/bin:$PATH"

# pyenv
export PYENV_ROOT="$HOME/.pyenv"
if [ -d "$PYENV_ROOT/bin" ]; then
	export PATH="$PYENV_ROOT/bin:$PATH"
	# Initialize pyenv
	if command -v pyenv >/dev/null 2>&1; then
		eval "$(pyenv init --path)"
	fi
fi

# Android SDK
export ANDROID_HOME="$HOME/Library/Android/sdk"
export PATH="$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools"

# ----------------------------------------------------------------------------
# 3. UNIVERSAL ALIASES (POSIX-safe)
# ----------------------------------------------------------------------------

# Directory Navigation
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'

# File Operations (POSIX-safe flags)
alias ll='ls -lah'
alias la='ls -A'
alias l='ls -CF'
alias mkdir='mkdir -p'

# System (POSIX-safe)
alias df='df -h'
alias du='du -h'

# Search with color (if supported)
if ls --color=auto >/dev/null 2>&1; then
	# GNU ls (Linux)
	alias ls='ls --color=auto'
	alias grep='grep --color=auto'
	alias fgrep='fgrep --color=auto'
	alias egrep='egrep --color=auto'
else
	# BSD ls (macOS)
	alias ls='ls -G'
	alias grep='grep --color=auto'
	alias fgrep='fgrep --color=auto'
	alias egrep='egrep --color=auto'
fi

# macOS memory info
if [ "$(uname)" = "Darwin" ]; then
	alias free='top -l 1 -s 0 | grep PhysMem'
fi

# Python3 as default python
if command -v python3 >/dev/null 2>&1; then
	alias python='python3'
fi

# Git shortcuts (universal)
alias gs='git status'
alias ga='git add'
alias gc='git commit -v'
alias gd='git diff'
alias gp='git push'
alias gl='git pull'
alias glog='git log --oneline --decorate --graph'

# History search with fzf
h() {
	local selected
	selected=$(fc -l 1 | fzf --tac --no-sort +m --query "$*" --prompt="History> " | sed -E 's/^[[:space:]]*[0-9]+[*]?[[:space:]]+//')
	if [ -n "$selected" ]; then
		# Try to insert into command line (zsh) or just print (bash)
		print -z "$selected" 2>/dev/null || printf '%s\n' "$selected"
	fi
}

# Create hist alias as well (history is a built-in that can't be easily overridden)
alias hist='h'

# ----------------------------------------------------------------------------
# 4. TOOL INITIALIZATION
# ----------------------------------------------------------------------------

# Google Cloud SDK (if installed)
if [ -f "$HOME/Downloads/google-cloud-sdk/path.sh.inc" ]; then
	. "$HOME/Downloads/google-cloud-sdk/path.sh.inc"
fi

if [ -f "$HOME/Downloads/google-cloud-sdk/completion.bash.inc" ]; then
	. "$HOME/Downloads/google-cloud-sdk/completion.bash.inc"
fi

# ----------------------------------------------------------------------------
# 4. PROJECT-SPECIFIC ALIASES
# ----------------------------------------------------------------------------

# Project shortcuts
alias ikas="$HOME/Documents/iknowaspot/iknowaspot/ikas.sh"

# Openclaw with environment variable (function to properly handle args)
openclaw() {
	PI_SSH_USER=giorgiocaizzi "$HOME/Documents/github/rp5-homeserver/services/openclaw/openclaw.sh" "$@"
}

# ----------------------------------------------------------------------------
# 5. FZF CONFIGURATION (Shared)
# ----------------------------------------------------------------------------

# fzf default options (works in both bash and zsh)
export FZF_DEFAULT_OPTS='
  --height=40%
  --layout=reverse
  --info=inline
  --border
  --margin=1
  --padding=1
  --preview-window=right:60%:wrap
  --bind ctrl-u:preview-half-page-up,ctrl-d:preview-half-page-down
  --color fg:252,bg:233,hl:67,fg+:252,bg+:235,hl+:81
  --color info:144,prompt:161,spinner:135,pointer:135,marker:118
'

# fzf Ctrl+R history search configuration
export FZF_CTRL_R_OPTS="
  --preview 'echo {2..}' --preview-window up:3:hidden:wrap
  --bind 'ctrl-/:toggle-preview'
  --bind 'ctrl-y:execute-silent(echo -n {2..} | pbcopy)+abort'
  --header 'Press CTRL-Y to copy command to clipboard'
"

# Use fd for file search if available
if command -v fd >/dev/null 2>&1; then
	export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
	export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
fi

# ----------------------------------------------------------------------------
# End of .profile
# ----------------------------------------------------------------------------
