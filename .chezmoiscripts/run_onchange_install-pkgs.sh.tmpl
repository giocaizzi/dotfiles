#!/usr/bin/env bash
set -e

# ============================================================================
# PACKAGE DEFINITIONS (Single Source of Truth)
# ============================================================================

# Core packages for ALL platforms/shells
CORE_PACKAGES=(
	"fzf"           # Fuzzy finder
	"git"           # Version control
	"vim"           # Text editor
	"fd"            # Modern find (used by fzf)
	"gh"            # GitHub CLI (used in Oh My Zsh plugins)
)

# Bash-specific packages for ALL platforms
BASH_PACKAGES=(
	"bash-completion"
)

# Zsh-specific packages (macOS only)
ZSH_PACKAGES=(
	"zsh-autosuggestions"
)

# ============================================================================
# PACKAGE NAME MAPPING (apt names differ from Homebrew)
# ============================================================================

map_package_name() {
	local pkg=$1
	case "$pkg" in
		"fd") echo "fd-find" ;;  # fd is fd-find on Debian/Ubuntu
		*) echo "$pkg" ;;
	esac
}

# ============================================================================
# INSTALLATION
# ============================================================================

{{- if eq .chezmoi.os "darwin" }}
# macOS: Use Homebrew
if ! command -v brew >/dev/null 2>&1; then
	echo "Homebrew is required but not installed" >&2
	echo "Install it from: https://brew.sh" >&2
	exit 1
fi

echo "Installing packages via Homebrew..."
ALL_PACKAGES=("${CORE_PACKAGES[@]}" "${BASH_PACKAGES[@]}" "${ZSH_PACKAGES[@]}")
for pkg in "${ALL_PACKAGES[@]}"; do
	if ! brew list "$pkg" >/dev/null 2>&1; then
		echo "Installing $pkg..."
		brew install "$pkg"
	fi
done

# Setup fzf key bindings
if [ -f "$(brew --prefix)/opt/fzf/install" ]; then
	echo "Setting up fzf key bindings..."
	"$(brew --prefix)/opt/fzf/install" --key-bindings --completion --no-update-rc
fi

# Install tools not in package managers
# pyenv
if ! command -v pyenv >/dev/null 2>&1; then
	echo "Installing pyenv..."
	brew install pyenv
fi

# pipx
if ! command -v pipx >/dev/null 2>&1; then
	echo "Installing pipx..."
	brew install pipx
fi

# cookiecutter
if ! command -v cookiecutter >/dev/null 2>&1; then
	echo "Installing cookiecutter..."
	brew install cookiecutter
fi

# oh-my-posh
if ! command -v oh-my-posh >/dev/null 2>&1; then
	echo "Installing oh-my-posh..."
	brew install oh-my-posh
fi

# Oh My Zsh
OHMYZSH_DIR="$HOME/.oh-my-zsh"
if [ -d "$OHMYZSH_DIR" ]; then
	echo "✓ Oh My Zsh already installed"
else
	echo "Installing Oh My Zsh..."
	git clone --depth=1 https://github.com/ohmyzsh/ohmyzsh.git "$OHMYZSH_DIR"
fi
{{- end }}

{{- if eq .chezmoi.os "linux" }}
# Linux: Use apt-get (bash only, no zsh)
echo "Installing packages via apt-get..."

# Install GitHub CLI repo (gh requires special setup)
if ! command -v gh >/dev/null 2>&1; then
	echo "Adding GitHub CLI repository..."
	(type -p wget >/dev/null || (sudo apt-get update && sudo apt-get install wget -y)) \
		&& sudo mkdir -p -m 755 /etc/apt/keyrings \
		&& wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
		&& sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
		&& echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
fi

# Build package list with apt name mapping
ALL_PACKAGES=("${CORE_PACKAGES[@]}" "${BASH_PACKAGES[@]}")
APT_PKGS=("curl" "python3-pip")  # Additional dependencies
for pkg in "${ALL_PACKAGES[@]}"; do
	APT_PKGS+=("$(map_package_name "$pkg")")
done

sudo apt-get update
sudo apt-get install -y "${APT_PKGS[@]}"

# Install tools not in apt or need special handling
if ! command -v pipx >/dev/null 2>&1; then
	echo "Installing pipx..."
	python3 -m pip install --user pipx
	python3 -m pipx ensurepath
fi

if ! command -v cookiecutter >/dev/null 2>&1; then
	echo "Installing cookiecutter..."
	pipx install cookiecutter
fi

if ! command -v pyenv >/dev/null 2>&1; then
	echo "Installing pyenv..."
	curl https://pyenv.run | bash
fi

if ! command -v oh-my-posh >/dev/null 2>&1; then
	echo "Installing oh-my-posh..."
	curl -s https://ohmyposh.dev/install.sh | bash -s
fi

# Create fd symlink (fd-find -> fd) for consistency with macOS
if command -v fdfind >/dev/null 2>&1 && ! command -v fd >/dev/null 2>&1; then
	mkdir -p "$HOME/.local/bin"
	ln -sf "$(which fdfind)" "$HOME/.local/bin/fd"
fi

echo "✓ All packages installed successfully"